<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶Æ‡¶ø‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ - ‡¶Ü‡¶∞‡ßç‡¶® ‡¶Æ‡¶æ‡¶®‡¶ø</title>
    <!-- Tailwind CSS ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Telegram Web App SDK ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase ‡¶Æ‡¶°‡¶ø‡¶â‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá -->
    <script type="module">
        // Firebase ‡¶Æ‡¶°‡¶ø‡¶â‡¶≤‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶á‡¶Æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, increment, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase-er debug log-gulo enable kora holo (‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡ßá)
        setLogLevel('debug');

        // ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá Firebase ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, 
            getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, increment, deleteDoc
        };
    </script>

    <style>
        /* CSS for smooth page transitions and responsive design */
        .page { display: none; transition: opacity 0.3s; }
        .page.active { display: block; opacity: 1; }
        .loader { border-top-color: #3B82F6; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        /* Scrollbar hide for clean look on mobile */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Basic font and background settings */
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-[2000] flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="loader w-12 h-12 border-4 border-gray-200 rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-600">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>

    <!-- Navigation Bar -->
    <nav class="bg-blue-600 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center max-w-lg">
            <h1 class="text-xl font-bold">üí∞ EarnApp</h1>
            <div class="flex gap-2 items-center">
                <span id="userBalance" class="bg-blue-700 px-3 py-1 rounded-lg text-lg font-semibold">$0.00</span>
                <!-- ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá -->
                <span id="userNameDisplay" class="text-sm italic ml-2">User</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto p-4 max-w-lg pb-24">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2>
            
            <div id="adminPanelButton" class="hidden mb-4">
                <button onclick="changePage('admin')" class="w-full bg-red-500 text-white py-3 rounded-xl shadow-lg hover:bg-red-600 transition duration-150 font-semibold">
                    ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ (Ad Management)
                </button>
            </div>
            
            <!-- Gemini Earning Tips Feature -->
            <div class="bg-blue-100 p-6 rounded-xl shadow-inner mb-6">
                <h3 class="text-xl font-semibold mb-3 text-blue-800 flex items-center gap-2">
                    ‚ú® ‡¶ú‡ßá‡¶Æ‡¶ø‡¶®‡¶ø‡¶∞ ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶ü‡¶ø‡¶™‡¶∏ 
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-purple-600"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-1.07.82V15h-2v-2.31l.98-.75c.44-.33.72-.81.72-1.34 0-.69-.56-1.25-1.25-1.25S11 8.81 11 9.5H9c0-1.66 1.34-3 3-3s3 1.34 3 3c0 1.05-.54 2.01-1.48 2.57z"/></svg>
                </h3>
                <div id="tipOutput" class="min-h-16 flex flex-col items-center justify-center bg-white p-4 rounded-lg border-dashed border-blue-300 shadow-md">
                    <p class="text-gray-500 text-sm">‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡¶ø‡¶™‡¶∏ ‡¶™‡ßá‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                </div>
                <button id="generateTipBtn" onclick="generateEarningTip()" class="w-full mt-4 bg-purple-600 text-white py-3 rounded-xl shadow-lg hover:bg-purple-700 transition duration-150 font-semibold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 0 0 0 8.488M9.75 3L9 3m4.5 9c0-2.21-1.79-4-4-4s-4 1.79-4 4 1.79 4 4 4m9-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" />
                    </svg>
                    <span>‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶ü‡¶ø‡¶™‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                </button>
            </div>

            <!-- Ad List -->
            <div class="bg-white p-6 rounded-xl shadow-xl">
                <h3 class="text-xl font-semibold mb-3 border-b pb-2">‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®</h3>
                <div id="adList" class="space-y-4 hide-scrollbar max-h-[50vh] overflow-y-auto">
                    <!-- Ads will be inserted here -->
                    <p class="text-gray-500 text-center py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶®‡ßá‡¶á‡•§</p>
                </div>
            </div>
        </div>

        <!-- Wallet Page -->
        <div id="wallet" class="page">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ì ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞</h2>
            
            <div class="bg-white p-6 rounded-xl shadow-xl mb-6 text-center">
                <p class="text-gray-600 text-sm mb-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                <p id="currentBalance" class="text-4xl font-extrabold text-green-600 mb-4">$0.00</p>
                <button onclick="showMessage('‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶® ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶Ü‡¶õ‡ßá‡•§', 'error')" class="bg-green-500 text-white py-3 px-8 rounded-xl shadow-lg hover:bg-green-600 transition duration-150 font-semibold">
                    ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶¶‡¶ø‡¶®
                </button>
            </div>

            <!-- Transaction History (Mock) -->
            <div class="bg-white p-6 rounded-xl shadow-xl">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h3>
                <div class="space-y-3 text-sm text-gray-700">
                    <div class="flex justify-between items-center">
                        <span>‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ (Ad #123)</span>
                        <span class="text-green-500 font-semibold">+ $0.01</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ (Ref: 456)</span>
                        <span class="text-green-500 font-semibold">+ $0.05</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç (01/11/2025)</span>
                        <span class="text-red-500 font-semibold">- $5.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Referrals Page -->
        <div id="referrals" class="page">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶ì ‡¶Ü‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            
            <div class="bg-white p-6 rounded-xl shadow-xl mb-6">
                <p class="text-gray-700 mb-4">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶Ü‡¶Æ‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£ ‡¶ú‡¶æ‡¶®‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∏‡¶´‡¶≤ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤‡ßá ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡¶æ‡¶®‡•§</p>
                <p class="font-semibold mb-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï:</p>
                <div class="flex gap-2">
                    <input type="text" id="refLink" readonly class="flex-1 border p-3 rounded-lg bg-gray-100 text-sm focus:ring-blue-500 focus:border-blue-500">
                    <button onclick="copyToClipboard('refLink')" class="bg-blue-500 text-white px-4 py-3 rounded-lg shadow hover:bg-blue-600 transition duration-150 font-semibold">
                        ‡¶ï‡¶™‡¶ø
                    </button>
                </div>
                <p id="refCount" class="mt-3 text-sm text-gray-600">‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤: 0 ‡¶ú‡¶®</p>
            </div>
        </div>

        <!-- Admin Page (Only for Admin) -->
        <div id="admin" class="page">
            <h2 class="text-2xl font-bold mb-4 text-red-600">‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
            <p class="text-sm text-gray-600 mb-4">Admin ID: <span id="adminIdDisplay">Loading...</span></p>

            <button onclick="showAdModal()" class="w-full bg-red-600 text-white py-3 rounded-xl shadow-lg hover:bg-red-700 transition duration-150 font-semibold mb-6">
                ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>

            <!-- Ad Management List -->
            <div class="bg-white p-6 rounded-xl shadow-xl">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2">‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®</h3>
                <div id="activeAdsList" class="space-y-4">
                    <!-- Active Ads will be listed here -->
                    <p class="text-gray-500 text-center py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶®‡ßá‡¶á‡•§</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 left-0 right-0 bg-white shadow-t-2xl z-50 border-t border-gray-200">
        <div class="container mx-auto max-w-lg flex justify-around items-center p-2">
            <button onclick="changePage('dashboard')" id="nav-dashboard" class="flex flex-col items-center text-blue-600 py-1 px-3 rounded-lg transition duration-150">
                <span class="text-xl">üè†</span>
                <span class="text-xs font-medium">‡¶π‡ßã‡¶Æ</span>
            </button>
            <button onclick="changePage('wallet')" id="nav-wallet" class="flex flex-col items-center text-gray-500 hover:text-blue-600 py-1 px-3 rounded-lg transition duration-150">
                <span class="text-xl">üí≥</span>
                <span class="text-xs font-medium">‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü</span>
            </button>
            <button onclick="changePage('referrals')" id="nav-referrals" class="flex flex-col items-center text-gray-500 hover:text-blue-600 py-1 px-3 rounded-lg transition duration-150">
                <span class="text-xl">üë•</span>
                <span class="text-xs font-medium">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤</span>
            </button>
        </div>
    </div>

    <!-- Modals are handled dynamically in JS -->

    <script>
        // --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ ---
        let db;
        let auth;
        let appId;
        let adUnsubscribe;
        let profileUnsubscribe;

        // ===================================================================
        // **!!! CRITICAL: ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡•§ ‡¶ö‡¶æ‡¶≤‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶á ‡ß©‡¶ü‡¶ø ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® !!!**
        // ===================================================================
        
        // Placeholder 1: ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Telegram Bot-‡¶è‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ (e.g., "my_earning_bot")
        const BOT_USERNAME = "@FTHifuck_bot"; 

        // Placeholder 2: ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Telegram User ID (7480500495)
        // ‡¶è‡¶ü‡¶ø‡¶á ‡¶π‡¶¨‡ßá ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ü‡¶á‡¶°‡¶ø‡•§ ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶π‡¶≤‡ßá ‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
        // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ User ID ‡¶ú‡¶æ‡¶®‡¶§‡ßá Telegram-‡¶è @LEGENDARY_POKEMO‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§
        const ADMIN_USER_IDS = ["7480500495"]; 

        // Placeholder 3: ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Firebase Web App ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
        const FALLBACK_FIREBASE_CONFIG = {
            apiKey: "AIzaSyACxca3u0GZH4Z3R-gtCBIp-mpd9Nk1iC8", 
            authDomain: "mini-app-be1ce.firebaseapp.com",
            projectId: "mini-app-be1ce", 
            storageBucket: "mini-app-be1ce.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };
        // ===================================================================


        let appState = {
            userId: 'guest', // ‡¶è‡¶á ID Firestore UID ‡¶¨‡¶æ Telegram ID ‡¶π‡¶¨‡ßá
            username: 'Guest User',
            isAdmin: false,
            isAuthReady: false,
            balance: 0.00,
            // Gemini API Key Canvas environment ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá ‡¶á‡¶®‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶¨‡ßá
            apiKey: typeof __api_key !== 'undefined' ? __api_key : "", 
        };

        // --- ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú/‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (alert() ‡¶è‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶® - ‡¶è‡¶ü‡¶ø ‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ) ---
        function showMessage(message, type = 'success') {
            const existingMessage = document.getElementById('custom-message');
            if (existingMessage) existingMessage.remove(); 

            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const messageHtml = `
                <div id="custom-message" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000] p-4">
                    <div class="p-5 rounded-xl shadow-2xl max-w-sm w-full transition transform duration-300 scale-100 ${bgColor} text-white">
                        <p class="font-bold mb-2">${type === 'success' ? '‡¶∏‡¶´‡¶≤!' : '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø!'}</p>
                        <p>${message}</p>
                        <button onclick="document.getElementById('custom-message').remove()" 
                                class="mt-4 bg-white text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-100 font-semibold">
                            ‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', messageHtml);
        }
        
        // --- ‡¶Æ‡ßá‡¶á‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ---

        function updateUI() {
            document.getElementById('userBalance').textContent = `$${appState.balance.toFixed(2)}`;
            if (document.getElementById('currentBalance')) {
                document.getElementById('currentBalance').textContent = `$${appState.balance.toFixed(2)}`;
            }
            document.getElementById('userNameDisplay').textContent = appState.username;

            // Admin Panel ‡¶ü‡¶ó‡¶≤ ‡¶ï‡¶∞‡¶æ
            if (appState.isAdmin) {
                document.getElementById('adminPanelButton').classList.remove('hidden');
                // Note: The UI displays Firebase UID for consistency, but the check uses TG ID.
                document.getElementById('adminIdDisplay').textContent = auth.currentUser ? auth.currentUser.uid : 'N/A';
            } else {
                document.getElementById('adminPanelButton')?.classList.add('hidden');
            }
            
            // ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            const refLinkInput = document.getElementById('refLink');
            if (refLinkInput) {
                // appState.userId (Firebase UID) ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                refLinkInput.value = `https://t.me/${BOT_USERNAME}?start=ref_${appState.userId}`;
            }
            
            // ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶∏‡¶∞‡¶æ‡¶®
            if (appState.isAuthReady) {
                document.getElementById('loadingScreen').classList.add('opacity-0');
                setTimeout(() => document.getElementById('loadingScreen').classList.add('hidden'), 300);
            }
        }
        
        async function authenticateUser() {
            const tg = window.Telegram?.WebApp;
            let initialTgId = 'guest'; 
            
            if (tg?.initDataUnsafe?.user?.id) {
                initialTgId = tg.initDataUnsafe.user.id.toString();
                appState.username = tg.initDataUnsafe.user.username || tg.initDataUnsafe.user.first_name || 'User';
                // Admin check Telegram ID ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                appState.isAdmin = ADMIN_USER_IDS.includes(initialTgId);
            } else {
                appState.username = 'Guest User (Anon)';
                appState.isAdmin = false;
            }
            
            const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            try {
                if (initialToken) {
                    // Canvas environment-‡¶è ‡¶•‡¶æ‡¶ï‡¶≤‡ßá custom token ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá sign-in 
                    await firebase.signInWithCustomToken(auth, initialToken);
                } else {
                    // Telegram-‡¶è‡¶∞ ‡¶¨‡¶æ‡¶á‡¶∞‡ßá ‡¶¨‡¶æ token ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá anonymous sign-in
                    await firebase.signInAnonymously(auth);
                }
                
                // Firebase UID-‡¶ï‡ßá appState.userId ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
                if (auth.currentUser) {
                    appState.userId = auth.currentUser.uid;
                } else {
                     throw new Error("User object is null after successful sign-in process.");
                }

            } catch (error) {
                console.error("Firebase Authentication Error during sign-in:", error);
                // Fallback to random ID if Firebase auth fails
                appState.userId = initialTgId === 'guest' ? crypto.randomUUID() : initialTgId;
                showMessage(`Authentication error: ${error.code}. ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏ ‡¶∞‡¶ø‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, 'error');
            }
            
            appState.isAuthReady = true;
            updateUI();
            
            // Firestore ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® (Authentication ‡¶∏‡¶´‡¶≤ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡¶∞)
            loadUserData();
            loadAds();
        }

        function loadUserData() {
            if (!appState.isAuthReady || !db || profileUnsubscribe) return;

            // Private data path: artifacts/{appId}/users/{userId}/profile_data/main_profile
            const collectionPath = `artifacts/${appId}/users/${appState.userId}/profile_data`; 
            const docRef = firebase.doc(db, collectionPath, 'main_profile'); 

            // Real-time listener
            profileUnsubscribe = firebase.onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    appState.balance = data.balance || 0.00;
                    document.getElementById('refCount').textContent = `‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤: ${data.referrals || 0} ‡¶ú‡¶®`;
                } else {
                    // Create initial profile if it doesn't exist
                    firebase.setDoc(docRef, { balance: 0.00, referrals: 0, lastSeen: new Date().toISOString() });
                    appState.balance = 0.00;
                }
                updateUI();
            }, (error) => {
                console.error("Error loading user data (onSnapshot):", error);
                // Note: Security rules will prevent this if not authenticated/authorized
                showMessage('‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ (Permission Error)', 'error');
            });
        }
        
        function loadAds() {
             if (!appState.isAuthReady || !db || adUnsubscribe) return;
             
             // Public data path for ads: artifacts/{appId}/public/data/ads
             const adsPath = `artifacts/${appId}/public/data/ads`;
             const q = firebase.query(firebase.collection(db, adsPath));

             // Real-time listener for Ads
             adUnsubscribe = firebase.onSnapshot(q, (snapshot) => {
                 const adListDiv = document.getElementById('adList');
                 adListDiv.innerHTML = '';
                 const activeAdsListDiv = document.getElementById('activeAdsList');
                 if (activeAdsListDiv) activeAdsListDiv.innerHTML = '';
                 
                 if (snapshot.empty) {
                     adListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶®‡ßá‡¶á‡•§</p>';
                     if (activeAdsListDiv) activeAdsListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶®‡ßá‡¶á‡•§</p>';
                     return;
                 }

                 snapshot.forEach(doc => {
                     const ad = doc.data();
                     const adReward = ad.reward || 0.01;
                     const adDuration = ad.duration || 10;
                     
                     // Ad for Dashboard (Users)
                     const adElement = `
                         <div class="border p-4 rounded-xl bg-gray-50 flex justify-between items-center transition duration-150 shadow-sm">
                             <div>
                                 <p class="font-semibold text-lg">${ad.title || 'Untitled Ad'}</p>
                                 <p class="text-sm text-gray-600">${adDuration} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</p>
                             </div>
                             <button onclick="startAd('${doc.id}', ${adReward}, ${adDuration}, this)" 
                                     class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-semibold shadow-md">
                                 ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ($${adReward.toFixed(2)})
                             </button>
                         </div>
                     `;
                     adListDiv.insertAdjacentHTML('beforeend', adElement);
                     
                     // Ad for Admin Panel
                     if (appState.isAdmin && activeAdsListDiv) {
                        const adminAdElement = `
                            <div class="flex justify-between items-center border-b pb-2 pt-2">
                                <span class="font-medium">${ad.title} ($${adReward.toFixed(2)}) - ${adDuration}s</span>
                                <button onclick="deleteAd('${doc.id}')" class="text-red-500 hover:text-red-700 text-sm">‡¶∏‡¶∞‡¶æ‡¶®</button>
                            </div>
                        `;
                        activeAdsListDiv.insertAdjacentHTML('beforeend', adminAdElement);
                     }
                 });
             }, (error) => {
                console.error("Error loading ads (onSnapshot):", error);
                showMessage('‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', 'error');
            });
        }

        /**
         * Ad ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßá ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡ßá ‡¶™‡ßÅ‡¶∞‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá‡•§
         */
        async function startAd(adId, reward, duration, button) {
            const originalText = button.textContent;
            button.disabled = true;
            
            let countdown = duration;
            const interval = setInterval(() => {
                button.textContent = `‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶® (${countdown}s)...`;
                countdown--;
                if (countdown < 0) {
                    clearInterval(interval);
                }
            }, 1000);

            showMessage(`‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶≤‡ßã! ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶® ${duration} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡•§`, 'success');
            
            await new Promise(resolve => setTimeout(resolve, duration * 1000));
            
            // Private data path: artifacts/{appId}/users/{userId}/profile_data/main_profile
            const collectionPath = `artifacts/${appId}/users/${appState.userId}/profile_data`; 
            const docRef = firebase.doc(db, collectionPath, 'main_profile'); 

            try {
                 await firebase.updateDoc(docRef, {
                    balance: firebase.increment(reward),
                    lastViewed: new Date().toISOString()
                });
                showMessage(`‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∂‡ßá‡¶∑! ‡¶Ü‡¶™‡¶®‡¶ø $${reward.toFixed(2)} ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®‡•§`, 'success');
            } catch (error) {
                 console.error("Error updating balance:", error);
                 showMessage('‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
                clearInterval(interval);
                // Force UI update
                updateUI();
            }
        }

        /**
         * ‡¶ú‡ßá‡¶Æ‡¶ø‡¶®‡¶ø ‡¶è‡¶™‡¶ø‡¶Ü‡¶á ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§‡¶ï‡ßÉ‡¶§ ‡¶Ü‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ü‡¶ø‡¶™‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡•§
         */
        async function generateEarningTip() {
            if (!appState.apiKey) {
                showMessage('API Key ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡¶Ø‡¶º‡•§ ‡¶ü‡¶ø‡¶™‡¶∏ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡¶Ø‡¶º‡•§', 'error');
                return;
            }
            
            const tipOutput = document.getElementById('tipOutput');
            const button = document.getElementById('generateTipBtn');
            const originalButtonContent = button.innerHTML;
            
            button.disabled = true;
            tipOutput.innerHTML = `
                <div class="loader w-6 h-6 border-2 border-blue-400 rounded-full animate-spin"></div>
                <p class="mt-2 text-blue-600 text-sm">‡¶ü‡¶ø‡¶™‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
            `;

            // System prompt for persona and language control
            const systemPrompt = "Apni ekjon bishishto Telegram Mini App-er earning specialist. Apni Telegram users-der jonyo choto, duto-tinti bakker earning tips deben. Ei tip-gulo tar Telegram app-er byabohar, referral ba ad-dekhar strategy-r opor dristi debe. Uttor-ti Bangla-te hobe. Apnar uttor-e kothao 'Gemini' ba 'AI' shobdota byabohar korben na.";
            const userQuery = `Amar current balance: ${appState.balance.toFixed(2)} USD. Ami ${appState.username}. Amar ad-dekhata ba referral baranor jonyo ekta choto tip din.`;
            
            // Construct API URL with the key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${appState.apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Google Search Grounding enabled
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            let finalTip = "‡¶ü‡¶ø‡¶™‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
            let sources = [];
            const maxRetries = 3;
            let retryDelay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            finalTip = candidate.content.parts[0].text;
                            
                            const groundingMetadata = candidate.groundingMetadata;
                            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                                sources = groundingMetadata.groundingAttributions
                                    .map(attribution => ({
                                        uri: attribution.web?.uri,
                                        title: attribution.web?.title,
                                    }))
                                    .filter(source => source.uri && source.title); 
                            }
                            break; // Success
                        }
                    } else if (response.status === 429) {
                        // Exponential backoff
                        console.warn(`Rate limit hit. Retrying in ${retryDelay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, retryDelay));
                        retryDelay *= 2;
                        continue; // Retry
                    } else {
                        const errorBody = await response.text();
                        console.error(`API Error ${response.status}:`, errorBody);
                        break; // Failure
                    }
                } catch (err) {
                    console.error("Fetch failed:", err);
                    break; // Failure
                }
            }
            
            // Output the final result or error message
            tipOutput.innerHTML = `<p class="text-gray-800">${finalTip}</p>`;
            
            if (sources.length > 0) {
                 const sourceHtml = sources.map(s => 
                     `<a href="${s.uri}" target="_blank" class="text-xs text-blue-500 hover:underline block">${s.title}</a>`
                 ).join('');
                 tipOutput.insertAdjacentHTML('beforeend', `<div class="mt-2 pt-2 border-t border-gray-200">
                     <p class="text-xs font-semibold mb-1">‡¶§‡¶•‡ßç‡¶Ø‡¶∏‡ßÇ‡¶§‡ßç‡¶∞ (Grounding):</p>${sourceHtml}</div>`);
            }

            button.disabled = false;
            button.innerHTML = originalButtonContent;
        }


        // --- UI/Modal Functions ---

        /** * ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø Modal ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡•§ (‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤)
         * @param {string} adId - (Optional) If editing an existing ad.
         * @param {Object} currentAd - (Optional) Current ad data for editing.
         */
        function showAdModal(adId = null, currentAd = {}) {
            const isEdit = adId !== null;
            const title = isEdit ? '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®' : '‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®';
            const buttonText = isEdit ? '‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®' : '‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®';
            
            if (!appState.isAdmin) {
                showMessage('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶®‡ßá‡¶á‡•§', 'error');
                return;
            }
            
            const modalHtml = `
                <div id="adModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[1100] p-4">
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">${title}</h3>
                        <form onsubmit="addNewAd(event, '${adId}')">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (Title)</label>
                                    <input type="text" id="adTitle" value="${currentAd.title || ''}" class="w-full border p-3 rounded-lg focus:ring-red-500 focus:border-red-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">‡¶™‡ßÅ‡¶∞‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ (Reward, USD)</label>
                                    <input type="number" id="adReward" value="${currentAd.reward || 0.01}" step="0.01" min="0.01" class="w-full border p-3 rounded-lg focus:ring-red-500 focus:border-red-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º (Duration, seconds)</label>
                                    <input type="number" id="adDuration" value="${currentAd.duration || 10}" min="1" class="w-full border p-3 rounded-lg focus:ring-red-500 focus:border-red-500" required>
                                </div>
                                <div class="flex gap-2 pt-2">
                                    <button type="submit" class="flex-1 bg-red-600 text-white py-3 rounded-xl hover:bg-red-700 transition duration-150 font-semibold">
                                        ${buttonText}
                                    </button>
                                    <button type="button" onclick="document.getElementById('adModal').remove()" 
                                            class="flex-1 bg-gray-500 text-white py-3 rounded-xl hover:bg-gray-600 transition duration-150 font-semibold">
                                        ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv.firstElementChild);
        }

        /**
         * ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® Firestore-‡¶è ‡¶Ø‡ßã‡¶ó ‡¶¨‡¶æ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßá‡•§
         */
        async function addNewAd(event, adId) {
            event.preventDefault();
            if (!appState.isAdmin) {
                showMessage('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶®‡ßá‡¶á‡•§', 'error');
                return;
            }

            const title = document.getElementById('adTitle').value;
            const reward = parseFloat(document.getElementById('adReward').value);
            const duration = parseInt(document.getElementById('adDuration').value, 10);
            
            if (isNaN(reward) || isNaN(duration) || reward <= 0 || duration <= 0) {
                 showMessage('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡ßÅ‡¶∞‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¶‡¶ø‡¶®‡•§', 'error');
                 return;
            }

            const adData = {
                title: title,
                reward: reward,
                duration: duration,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            const adsPath = `artifacts/${appId}/public/data/ads`;
            const docRef = adId 
                ? firebase.doc(db, adsPath, adId)
                : firebase.doc(firebase.collection(db, adsPath)); // Firestore will generate new ID

            try {
                await firebase.setDoc(docRef, adData, { merge: true });
                showMessage(adId ? '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!' : '‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success');
                document.getElementById('adModal').remove();
            } catch (error) {
                console.error("Error adding/updating document:", error);
                showMessage('‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶Ø‡ßã‡¶ó ‡¶¨‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ (Permission/Network Error)', 'error');
            }
        }

        /**
         * ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßá‡•§ (‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤)
         */
        async function deleteAd(adId) {
            if (!appState.isAdmin) {
                showMessage('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶®‡ßá‡¶á‡•§', 'error');
                return;
            }
            
            const adsPath = `artifacts/${appId}/public/data/ads`;
            const docRef = firebase.doc(db, adsPath, adId);
            
            try {
                await firebase.deleteDoc(docRef);
                showMessage('‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success');
            } catch (error) {
                console.error("Error deleting document:", error);
                showMessage('‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∏‡¶∞‡¶æ‡¶®‡ßã‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ (Permission Error)', 'error');
            }
        }

        /**
         * ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßá‡¶ú ‡¶•‡ßá‡¶ï‡ßá ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶™‡ßá‡¶ú‡ßá ‡¶Ø‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ
         */
        function changePage(targetPageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            
            document.getElementById(targetPageId).classList.add('active');
            
            // Navigation Bar-‡¶è‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            document.querySelectorAll('.fixed .flex-col').forEach(btn => {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-500');
            });

            const navButton = document.getElementById(`nav-${targetPageId}`);
            if (navButton) {
                navButton.classList.remove('text-gray-500');
                navButton.classList.add('text-blue-600');
            }
        }

        /**
         * ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡¶™‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ
         */
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            element.setSelectionRange(0, 99999); // Mobile compatibility

            try {
                // document.execCommand('copy') is generally preferred in iFrame environments
                document.execCommand('copy'); 
                showMessage('‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success');
            } catch (err) {
                console.error('Failed to copy text:', err);
                showMessage('‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø, ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
            }
        }
        
        /**
         * ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®
         */
        function initApp() {
            // 1. App ID ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-earn-app-id';

            // 2. Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            let firebaseConfig;
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.warn("Canvas Firebase config not found or invalid. Using fallback config.");
                firebaseConfig = FALLBACK_FIREBASE_CONFIG;
            }

            // 3. Firebase ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡¶æ
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.getFirestore(app);
            auth = firebase.getAuth(app);
            
            // 4. Authentication ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ
            authenticateUser();

            // Default page set up
            changePage('dashboard');
        }

        // Initialize app when page loads
        window.addEventListener('load', initApp);
    </script>
</body>
</html>